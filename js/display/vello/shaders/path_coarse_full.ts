/* eslint-disable */
import bump from './shared/bump.js';
import cubic from './shared/cubic.js';
import segment from './shared/segment.js';
import tile from './shared/tile.js';
import pathtag from './shared/pathtag.js';
import config from './shared/config.js';

export default `${config}
${pathtag}
${tile}
${segment}
${cubic}
${bump}
@group(0)@binding(0)var<uniform>f:aF;@group(0)@binding(1)var<storage>k:array<u32>;@group(0)@binding(2)var<storage>bV:array<X>;@group(0)@binding(3)var<storage>el:array<fh>;@group(0)@binding(4)var<storage>bE:array<cw>;struct eC{F:atomic<i32>,W:atomic<u32>}@group(0)@binding(5)var<storage,read_write>ad:eh;@group(0)@binding(6)var<storage,read_write>N:array<eC>;@group(0)@binding(7)var<storage,read_write>W:array<dx>;struct cn{U:f32,bm:f32,bl:f32}const bn=.67;fn cm(x:f32)->f32{return x*inverseSqrt(sqrt(1.-bn+(bn*bn*bn*bn+.25*x*x)));}const ck=.39;fn cl(x:f32)->f32{return x*sqrt(1.-ck+(ck*ck+.5*x*x));}fn eB(l:vec2f,n:vec2f,v:vec2f,c_:f32)->cn{let de=n-l;let dd=v-n;let s=de-dd;let cross=(v.x-l.x)*s.y-(v.y-l.y)*s.x;let dc=select(1./cross,1.e9,abs(cross)<1.e-9);let B=dot(de,s)*dc;let cj=dot(dd,s)*dc;let aY=abs(cross/(length(s)*(cj-B)));let bm=cm(B);let bl=cm(cj);var U=0.;if aY<1e9{let ey=abs(bl-bm);let db=sqrt(aY);if sign(B)==sign(cj){U=db;}else{let cq=c_/db;U=c_/cm(cq);}U*=ey;}return cn(U,bm,bl);}fn eA(l:vec2f,n:vec2f,v:vec2f,o:f32)->vec2f{let ao=1.-o;return l*(ao*ao)+(n*(ao*2.)+v*o)*o;}fn bP(l:vec2f,n:vec2f,v:vec2f,G:vec2f,o:f32)->vec2f{let ao=1.-o;return l*(ao*ao*ao)+(n*(ao*ao*3.)+(v*(ao*3.)+G*o)*o)*o;}fn ez()->u32{var aR=atomicAdd(&ad.W,1u)+1u;if aR+1u>f.ij{aR=0u;atomicOr(&ad.af,gX);}return aR;}const da=16u;@compute @workgroup_size(256)fn main(@builtin(global_invocation_id)E:vec3u,){if(atomicLoad(&ad.af)&(eg|fl))!=0u{return;}let i=E.x;let D=k[f.dD+(i>>2u)];let bX=(i&3u)*8u;var bW=(D>>bX)&0xffu;if(bW&ff)!=0u{let a5=el[E.x];let O=bE[a5.R];let fA=(a5.at&ih)!=0u;let e=vec4i(O.e);let l=a5.l;let n=a5.n;let v=a5.v;let G=a5.G;let c9=3.*(v-n)+l-G;let ex=dot(c9,c9);let c8=.25;let ci=c8*.1;let c7=(c8-ci);let ew=432.*ci*ci;var bk=max(u32(ceil(pow(ex*(1./ew),1./6.))),1u);bk=min(bk,da);var cZ:array<cn,da>;var U=0.;var aM=l;let step=1./f32(bk);for(var c=0u;c<bk;c+=1u){let o=f32(c+1u)*step;let aN=bP(l,n,v,G,o);var aL=bP(l,n,v,G,o- .5*step);aL=2.*aL- .5*(aM+aN);let an=eB(aM,aL,aN,sqrt(c7));cZ[c]=an;U+=an.U;aM=aN;}let bz=max(u32(ceil(U*(.5/sqrt(c7)))),1u);var T=l;aM=l;let c6=U/f32(bz);var bN=1u;var cf=0.;for(var c=0u;c<bk;c+=1u){let o=f32(c+1u)*step;let aN=bP(l,n,v,G,o);var aL=bP(l,n,v,G,o- .5*step);aL=2.*aL- .5*(aM+aN);let an=cZ[c];let c5=cl(an.bm);let ev=cl(an.bl);let eu=1./(ev-c5);var ce=f32(bN)*c6;while bN==bz||ce<cf+an.U{var am:vec2f;if bN==bz{am=G;}else{let et=(ce-cf)/an.U;let a=mix(an.bm,an.bl,et);let es=cl(a);let o=(es-c5)*eu;am=eA(aM,aL,aN,o);}let bO=min(T,am)-a5.aO;let c4=max(T,am)+a5.aO;let ax=am-T;let er=1./ax.x;let ch=select(ax.x/ax.y,1.e9,abs(ax.y)<1.e-9);let ap=1./f32(cD);let bd=1./f32(bi);let m=(a5.aO.x+abs(ch)*(.5*f32(bi)+a5.aO.y))*ap;let b=ch;let a=(T.x-(T.y- .5*f32(bi))*b)*ap;var B=i32(floor(bO.x*ap));var J=i32(floor(c4.x*ap)+1.);var I=i32(floor(bO.y*bd));var M=i32(floor(c4.y*bd)+1.);B=clamp(B,e.x,e.z);J=clamp(J,e.x,e.z);I=clamp(I,e.y,e.w);M=clamp(M,e.y,e.w);var cd=a+b*f32(I);let dn=e.z-e.x;var Z=i32(O.N)+(I-e.y)*dn-e.x;var aW=i32(floor(T.x*ap));var cc=i32(floor(am.x*ap));if ax.y<0.{let eq=aW;aW=cc;cc=eq;}for(var y=I;y<M;y+=1){let ep=f32(y)*f32(bi);let c3=max(aW+1,e.x);if!fA&&bO.y<ep&&c3<e.z{let F=select(-1,1,ax.y<0.);let ay=Z+c3;atomicAdd(&N[ay].F,F);}var bM=cc;if y+1<M{let eo=f32(y+1)*f32(bi);let en=T.x+(eo-T.y)*ch;bM=i32(floor(en*ap));}let c2=min(aW,bM);let c1=max(aW,bM);var cb=min(i32(floor(cd-m)),c2);var ca=max(i32(ceil(cd+m)),c1+1);cb=clamp(cb,B,J);ca=clamp(ca,B,J);var al:dx;for(var x=cb;x<ca;x+=1){let cg=f32(x)*f32(cD);let ay=Z+x;let c0=ez();let em=atomicExchange(&N[ay].W,c0);al.cx=T;al.aq=ax;var aT=0.;if!fA{aT=mix(T.y,am.y,(cg-T.x)*er);if bO.x<cg{let bF=vec2(cg,aT);if ax.x<0.{al.aq=bF-T;}else{al.cx=bF;al.aq=am-bF;}if al.aq.x==0.{al.aq.x=sign(ax.x)*1e-9;}}if x<=c2||c1<x{aT=1e9;}}al.aT=aT;al.d2=em;W[c0]=al;}cd+=b;Z+=dn;aW=bM;}bN+=1u;ce+=c6;T=am;}cf+=an.U;aM=aN;}}}`
