/* eslint-disable */
import ptcl from './shared/ptcl.js';
import blend from './shared/blend.js';
import config from './shared/config.js';
import segment from './shared/segment.js';
import pre from './shared/pre.js';

export default `${pre}struct bv{O:m,ak:j}${segment}
${config}
@group(0)@binding(0)var<uniform>n:aV;@group(0)@binding(1)var<storage>X:array<bv>;@group(0)@binding(2)var<storage>ak:array<dL>;${blend}
${ptcl}
const f7=512;@group(0)@binding(3)var aO:texture_storage_2d<rgba8unorm,write>;@group(0)@binding(4)var<storage>q:a0;@group(0)@binding(5)var e1:texture_2d<h>;@group(0)@binding(6)var<storage>info:a0;@group(0)@binding(7)var dX:texture_2d<h>;fn hS(C:j)->fv{let F=q[C+f];let O=m(q[C+2u]);return fv(F,O);}fn hR(C:j)->fu{let F=q[C+f];let c5=bitcast<h>(q[C+2u]);return fu(F,c5);}fn hQ(C:j)->eu{let c4=q[C+f];return eu(c4);}fn hP(C:j)->g4{let dx=q[C+f];let a_=dx>>2u;let be=dx&3u;let Q=q[C+2u];let er=bitcast<h>(info[Q]);let fs=bitcast<h>(info[Q+f]);let dM=bitcast<h>(info[Q+2u]);return g4(a_,be,er,fs,dM);}fn hO(C:j)->g3{let dx=q[C+f];let a_=dx>>2u;let be=dx&3u;let Q=q[C+2u];let P=bitcast<L>(vec4(info[Q],info[Q+f],info[Q+2u],info[Q+3u]));let cN=bitcast<B>(vec2(info[Q+4u],info[Q+5u]));let bd=bitcast<h>(info[Q+6u]);let aZ=bitcast<h>(info[Q+7u]);let f6=info[Q+8u];let aE=f6>>3u;let bI=f6&7u;return g3(a_,be,P,cN,bd,aZ,bI,aE);}fn hN(C:j)->g2{let Q=q[C+f];let P=bitcast<L>(vec4(info[Q],info[Q+f],info[Q+2u],info[Q+3u]));let cN=bitcast<B>(vec2(info[Q+4u],info[Q+5u]));let xy=info[Q+6u];let f5=info[Q+7u];let be=info[Q+8u];let x=m(xy>>16u);let y=m(xy&65535u);let aR=m(f5>>16u);let dw=m(f5&65535u);let cM=vec2(be>>2u,be&0x3);return g2(P,cN,vec2(x,y),vec2(aR,dw),cM);}fn hM(C:j)->et{let bm=q[C+f];let cj=bitcast<L>(vec4(q[C+2u],q[C+3u],q[C+4u],q[C+5u]));let ci=bitcast<L>(vec4(q[C+6u],q[C+7u],q[C+8u],q[C+9u]));let ch=bitcast<L>(vec4(q[C+10u],q[C+11u],q[C+12u],q[C+13u]));let b5=bitcast<L>(vec4(q[C+14u],q[C+15u],q[C+16u],q[C+17u]));let cg=bitcast<L>(vec4(q[C+18u],q[C+19u],q[C+20u],q[C+21u]));let c3=q[C+22u]==f;return et(bm,cj,ci,ch,b5,cg,c3);}const f4=e;const f3=f;const f2=2u;fn be(A:h,by:j)->h{switch by{case f4:{return clamp(A,c,d);}case f3:{return fract(A);}default:{return abs(A- 2.*round(.5*A));}}}fn d1(i:m,size:m,by:j)->m{switch by{case f4:{return clamp(i,0i,size- 1i);}case f3:{if i>=0i{return i % size;}else{return size-((-i- 1i)% size)- 1i;}}case f2:{let hK=select(i,-i- 1i,i<0i);let e7=hK %(size*2i);if e7<size{return e7;}else{return 2i*size-e7- 1i;}}default:{return 0i;}}}const ai=4u;fn f8(F:bv,xy:B,cW:bool)->array<h,ai>{var at:array<h,ai>;let hJ=h(F.O);for(var i=e;i<ai;i+=f){at[i]=hJ;}var cD=F.ak;while cD!=e{let an=ak[cD];let y=an.cL.y-xy.y;let S=clamp(y,c,d);let V=clamp(y+an.aD.y,c,d);let dB=S-V;if dB!=c{let f1=d/an.aD.y;let hI=(S-y)*f1;let hH=(V-y)*f1;let f0=an.cL.x-xy.x;let J=f0+hI*an.aD.x;let T=f0+hH*an.aD.x;let hG=min(J,T);let hF=max(J,T);for(var i=e;i<ai;i+=f){let f_=h(i);let cF=min(hG-f_,d)- 1.e-6;let fZ=hF-f_;let b=min(fZ,d);let t=max(b,c);let cn=max(cF,c);let a=(b+.5*(cn*cn-t*t)-cF)/(fZ-cF);at[i]+=a*dB;}}let bc=sign(an.aD.x)*clamp(xy.y-an.bc+d,c,d);for(var i=e;i<ai;i+=f){at[i]+=bc;}cD=an.eq;}if cW{for(var i=e;i<ai;i+=f){let a=at[i];at[i]=abs(a- 2.*round(.5*a));}}else{for(var i=e;i<ai;i+=f){at[i]=min(abs(at[i]),d);}}return at;}fn hL(seg:j,c5:h,xy:B)->array<h,ai>{var cT:array<h,ai>;for(var i=e;i<ai;i+=f){cT[i]=1e9;}var cD=seg;while cD!=e{let an=ak[cD];let aD=an.aD;let fY=xy+vec2(.5,.5)-an.cL;let bi=d/dot(aD,aD);for(var i=e;i<ai;i+=f){let fX=vec2(fY.x+h(i),fY.y);let A=clamp(dot(fX,aD)*bi,c,d);cT[i]=min(cT[i],length(aD*A-fX));}cD=an.eq;}for(var i=e;i<ai;i+=f){cT[i]=clamp(c5+.5-cT[i],c,d);}return cT;}@compute @workgroup_size(4,16)fn main(@builtin(global_invocation_id)N:M,@builtin(local_invocation_id)k:M,@builtin(workgroup_id)ap:M){let aK=ap.y*n.aM+ap.x;let xy=vec2(h(N.x*ai),h(N.y));var rgba:array<L,ai>;for(var i=e;i<ai;i+=f){rgba[i]=unpack4x8unorm(n.iH).wzyx;}var fT:array<array<j,ai>,eD>;var bk=e;var at:array<h,ai>;var C=aK*es;let gt=q[C];C+=f;while true{let a8=q[C];if a8==g0{break;}switch a8{case g_:{let cJ=hS(C);let ak=cJ.F>>f;let cW=(cJ.F&f)!=e;let F=bv(cJ.O,ak);at=f8(F,xy,cW);C+=3u;}case gZ:{let a6=hR(C);at=hL(a6.F,a6.c5,xy);C+=3u;}case gY:{for(var i=e;i<ai;i+=f){at[i]=d;}C+=f;}case gX:{let b2=hQ(C);let e6=unpack4x8unorm(b2.c4).wzyx;for(var i=e;i<ai;i+=f){let bD=e6*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}C+=2u;}case gW:{let cU=hP(C);let cn=cU.er*xy.x+cU.fs*xy.y+cU.dM;for(var i=e;i<ai;i+=f){let hE=cn+cU.er*h(i);let x=m(round(be(hE,cU.be)*h(f7- 1)));let dv=textureLoad(e1,vec2(x,m(cU.a_)),0);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}C+=3u;}case gV:{let bC=hO(C);let bd=bC.bd;let aZ=bC.aZ;let hD=bC.bI==hh;let hC=bC.bI==hi;let hB=bC.bI==hg;let fW=(bC.aE&hf)!=e;let fV=select(d/aZ,c,hC);let hA=select(d,-d,fW||(d-bd)<c);let hz=sign(d-bd);for(var i=e;i<ai;i+=f){let du=vec2(xy.x+h(i),xy.y);let fU=bC.P.xy*du.x+bC.P.zw*du.y+bC.cN;let x=fU.x;let y=fU.y;let xx=x*x;let yy=y*y;var A=c;var dY=true;if hD{let a=aZ-yy;A=sqrt(a)+x;dY=a>=c;}else if hB{A=(xx+yy)/x;dY=A>=c&&x!=c;}else if aZ>d{A=sqrt(xx+yy)-x*fV;}else{let a=xx-yy;A=hA*sqrt(a)-x*fV;dY=a>=c&&A>=c;}if dY{A=be(bd+hz*A,bC.be);A=select(A,d-A,fW);let x=m(round(A*h(f7- 1)));let dv=textureLoad(e1,vec2(x,m(bC.a_)),0);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}}C+=3u;}case gU:{let aF=hN(C);let aR=aF.bR.x;let dw=aF.bR.y;for(var i=e;i<ai;i+=f){if at[i]!=c{let du=vec2(xy.x+h(i),xy.y);let e5=aF.P.xy*du.x+aF.P.zw*du.y+aF.cN;let d_=vec4i(vec4(floor(e5),ceil(e5)));let dZ=vec4(d1(d_.x,aR,aF.cM.x),d1(d_.y,dw,aF.cM.y),d1(d_.z,aR,aF.cM.x),d1(d_.w,dw,aF.cM.y))+vec4(aF.gQ,aF.gQ);let e4=fract(e5);let a=d0(textureLoad(dX,dZ.xy,0));let b=d0(textureLoad(dX,dZ.xw,0));let t=d0(textureLoad(dX,dZ.zy,0));let cn=d0(textureLoad(dX,dZ.zw,0));let dv=mix(mix(a,b,e4.y),mix(t,cn,e4.y),e4.x);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}}C+=2u;}case gT:{if bk<eD{for(var i=e;i<ai;i+=f){fT[bk][i]=pack4x8unorm(rgba[i]);rgba[i]=vec4(c);}}else{}bk+=f;C+=f;}case gS:{let aB=hM(C);bk-=f;for(var i=e;i<ai;i+=f){var fS:j;if bk<eD{fS=fT[bk][i];}else{}let bg=unpack4x8unorm(fS);var a4=rgba[i];var aL:L;if aB.c3{let e3=d/max(a4.a,1e-6);a4=vec4(a4.rgb*e3,a4.a);aL=aB.cj*a4.r+aB.ci*a4.g+aB.ch*a4.b+aB.b5*a4.a+aB.cg;aL=clamp(aL,vec4(c),vec4(d));aL=vec4(aL.rgb*aL.a,aL.a);}else{let new_rgb=aB.cj.rgb*a4.r+aB.ci.rgb*a4.g+aB.ch.rgb*a4.b+aB.b5.rgb*a4.a*a4.a+aB.cg.rgb*a4.a;aL=aB.b5.a*vec4(new_rgb,a4.a);aL=clamp(aL,vec4(c),vec4(min(d,aL.a)));}let e6=aL*at[i];rgba[i]=jg(bg,e6,aB.bm);}C+=23u;}case gR:{C=q[C+f];}default:{}}}let e2=vec2u(xy);for(var i=e;i<ai;i+=f){let cE=e2+vec2(i,e);if cE.x<n.he&&cE.y<n.hd{var aL=rgba[i];if n.iG!=e{let e3=d/max(aL.a,1e-6);aL=vec4(aL.rgb*e3,aL.a);}textureStore(aO,vec2i(cE),aL);}}}fn d0(rgba:L)->L{return vec4(rgba.rgb*rgba.a,rgba.a);}`
