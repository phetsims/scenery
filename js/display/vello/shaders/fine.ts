/* eslint-disable */
import ptcl from './shared/ptcl.js';
import blend from './shared/blend.js';
import config from './shared/config.js';
import segment from './shared/segment.js';
import pre from './shared/pre.js';

export default `${pre}struct bw{O:m,ak:j}${segment}
${config}
@group(0)@binding(0)var<uniform>n:aV;@group(0)@binding(1)var<storage>Y:array<bw>;@group(0)@binding(2)var<storage>ak:array<dM>;${blend}
${ptcl}
const f8=512;@group(0)@binding(3)var aO:texture_storage_2d<rgba8unorm,write>;@group(0)@binding(4)var<storage>q:a0;@group(0)@binding(5)var e2:texture_2d<h>;@group(0)@binding(6)var<storage>info:a0;@group(0)@binding(7)var dY:texture_2d<h>;fn hT(C:j)->fw{let F=q[C+f];let O=m(q[C+2u]);return fw(F,O);}fn hS(C:j)->fv{let F=q[C+f];let c6=bitcast<h>(q[C+2u]);return fv(F,c6);}fn hR(C:j)->ev{let c5=q[C+f];return ev(c5);}fn hQ(C:j)->g5{let dy=q[C+f];let a_=dy>>2u;let bf=dy&3u;let P=q[C+2u];let es=bitcast<h>(info[P]);let ft=bitcast<h>(info[P+f]);let dN=bitcast<h>(info[P+2u]);return g5(a_,bf,es,ft,dN);}fn hP(C:j)->g4{let dy=q[C+f];let a_=dy>>2u;let bf=dy&3u;let P=q[C+2u];let Q=bitcast<L>(vec4(info[P],info[P+f],info[P+2u],info[P+3u]));let cO=bitcast<B>(vec2(info[P+4u],info[P+5u]));let be=bitcast<h>(info[P+6u]);let aZ=bitcast<h>(info[P+7u]);let f7=info[P+8u];let aF=f7>>3u;let bJ=f7&7u;return g4(a_,bf,Q,cO,be,aZ,bJ,aF);}fn hO(C:j)->g3{let P=q[C+f];let Q=bitcast<L>(vec4(info[P],info[P+f],info[P+2u],info[P+3u]));let cO=bitcast<B>(vec2(info[P+4u],info[P+5u]));let xy=info[P+6u];let f6=info[P+7u];let bf=info[P+8u];let bd=bitcast<h>(info[P+9u]);let x=m(xy>>16u);let y=m(xy&65535u);let aR=m(f6>>16u);let dx=m(f6&65535u);let cN=vec2(bf>>2u,bf&3u);return g3(Q,cO,vec2(x,y),vec2(aR,dx),cN,bd);}fn hN(C:j)->eu{let bn=q[C+f];let ck=bitcast<L>(vec4(q[C+2u],q[C+3u],q[C+4u],q[C+5u]));let cj=bitcast<L>(vec4(q[C+6u],q[C+7u],q[C+8u],q[C+9u]));let ci=bitcast<L>(vec4(q[C+10u],q[C+11u],q[C+12u],q[C+13u]));let b6=bitcast<L>(vec4(q[C+14u],q[C+15u],q[C+16u],q[C+17u]));let ch=bitcast<L>(vec4(q[C+18u],q[C+19u],q[C+20u],q[C+21u]));let c4=q[C+22u]==f;return eu(bn,ck,cj,ci,b6,ch,c4);}const f5=e;const f4=f;const f3=2u;fn bf(A:h,bz:j)->h{switch bz{case f5:{return clamp(A,c,d);}case f4:{return fract(A);}default:{return abs(A- 2.*round(.5*A));}}}fn d2(i:m,size:m,bz:j)->m{switch bz{case f5:{return clamp(i,0i,size- 1i);}case f4:{if i>=0i{return i % size;}else{return size-((-i- 1i)% size)- 1i;}}case f3:{let hL=select(i,-i- 1i,i<0i);let e8=hL %(size*2i);if e8<size{return e8;}else{return 2i*size-e8- 1i;}}default:{return 0i;}}}const ai=4u;fn f9(F:bw,xy:B,cX:bool)->array<h,ai>{var at:array<h,ai>;let hK=h(F.O);for(var i=e;i<ai;i+=f){at[i]=hK;}var cE=F.ak;while cE!=e{let an=ak[cE];let y=an.cM.y-xy.y;let S=clamp(y,c,d);let V=clamp(y+an.aE.y,c,d);let dC=S-V;if dC!=c{let f2=d/an.aE.y;let hJ=(S-y)*f2;let hI=(V-y)*f2;let f1=an.cM.x-xy.x;let J=f1+hJ*an.aE.x;let T=f1+hI*an.aE.x;let hH=min(J,T);let hG=max(J,T);for(var i=e;i<ai;i+=f){let f0=h(i);let cG=min(hH-f0,d)- 1.e-6;let f_=hG-f0;let b=min(f_,d);let t=max(b,c);let co=max(cG,c);let a=(b+.5*(co*co-t*t)-cG)/(f_-cG);at[i]+=a*dC;}}let bc=sign(an.aE.x)*clamp(xy.y-an.bc+d,c,d);for(var i=e;i<ai;i+=f){at[i]+=bc;}cE=an.er;}if cX{for(var i=e;i<ai;i+=f){let a=at[i];at[i]=abs(a- 2.*round(.5*a));}}else{for(var i=e;i<ai;i+=f){at[i]=min(abs(at[i]),d);}}return at;}fn hM(seg:j,c6:h,xy:B)->array<h,ai>{var cU:array<h,ai>;for(var i=e;i<ai;i+=f){cU[i]=1e9;}var cE=seg;while cE!=e{let an=ak[cE];let aE=an.aE;let fZ=xy+vec2(.5,.5)-an.cM;let bj=d/dot(aE,aE);for(var i=e;i<ai;i+=f){let fY=vec2(fZ.x+h(i),fZ.y);let A=clamp(dot(fY,aE)*bj,c,d);cU[i]=min(cU[i],length(aE*A-fY));}cE=an.er;}for(var i=e;i<ai;i+=f){cU[i]=clamp(c6+.5-cU[i],c,d);}return cU;}@compute @workgroup_size(4,16)fn main(@builtin(global_invocation_id)N:M,@builtin(local_invocation_id)k:M,@builtin(workgroup_id)ap:M){let aK=ap.y*n.aM+ap.x;let xy=vec2(h(N.x*ai),h(N.y));var rgba:array<L,ai>;for(var i=e;i<ai;i+=f){rgba[i]=unpack4x8unorm(n.iI).wzyx;}var fU:array<array<j,ai>,eE>;var bl=e;var at:array<h,ai>;var C=aK*et;let gu=q[C];C+=f;while true{let a8=q[C];if a8==g1{break;}switch a8{case g0:{let cK=hT(C);let ak=cK.F>>f;let cX=(cK.F&f)!=e;let F=bw(cK.O,ak);at=f9(F,xy,cX);C+=3u;}case g_:{let a6=hS(C);at=hM(a6.F,a6.c6,xy);C+=3u;}case gZ:{for(var i=e;i<ai;i+=f){at[i]=d;}C+=f;}case gY:{let b3=hR(C);let e7=unpack4x8unorm(b3.c5).wzyx;for(var i=e;i<ai;i+=f){let bE=e7*at[i];rgba[i]=rgba[i]*(d-bE.a)+bE;}C+=2u;}case gX:{let cV=hQ(C);let co=cV.es*xy.x+cV.ft*xy.y+cV.dN;for(var i=e;i<ai;i+=f){let hF=co+cV.es*h(i);let x=m(round(bf(hF,cV.bf)*h(f8- 1)));let dw=textureLoad(e2,vec2(x,m(cV.a_)),0);let bE=dw*at[i];rgba[i]=rgba[i]*(d-bE.a)+bE;}C+=3u;}case gW:{let bD=hP(C);let be=bD.be;let aZ=bD.aZ;let hE=bD.bJ==hi;let hD=bD.bJ==hj;let hC=bD.bJ==hh;let fX=(bD.aF&hg)!=e;let fW=select(d/aZ,c,hD);let hB=select(d,-d,fX||(d-be)<c);let hA=sign(d-be);for(var i=e;i<ai;i+=f){let dv=vec2(xy.x+h(i),xy.y);let fV=bD.Q.xy*dv.x+bD.Q.zw*dv.y+bD.cO;let x=fV.x;let y=fV.y;let xx=x*x;let yy=y*y;var A=c;var dZ=true;if hE{let a=aZ-yy;A=sqrt(a)+x;dZ=a>=c;}else if hC{A=(xx+yy)/x;dZ=A>=c&&x!=c;}else if aZ>d{A=sqrt(xx+yy)-x*fW;}else{let a=xx-yy;A=hB*sqrt(a)-x*fW;dZ=a>=c&&A>=c;}if dZ{A=bf(be+hA*A,bD.bf);A=select(A,d-A,fX);let x=m(round(A*h(f8- 1)));let dw=textureLoad(e2,vec2(x,m(bD.a_)),0);let bE=dw*at[i];rgba[i]=rgba[i]*(d-bE.a)+bE;}}C+=3u;}case gV:{let aC=hO(C);let aR=aC.bS.x;let dx=aC.bS.y;for(var i=e;i<ai;i+=f){if at[i]!=c{let dv=vec2(xy.x+h(i),xy.y);let e6=aC.Q.xy*dv.x+aC.Q.zw*dv.y+aC.cO;let d0=vec4i(vec4(floor(e6),ceil(e6)));let d_=vec4(d2(d0.x,aR,aC.cN.x),d2(d0.y,dx,aC.cN.y),d2(d0.z,aR,aC.cN.x),d2(d0.w,dx,aC.cN.y))+vec4(aC.gR,aC.gR);let e5=fract(e6);let a=d1(textureLoad(dY,d_.xy,0));let b=d1(textureLoad(dY,d_.xw,0));let t=d1(textureLoad(dY,d_.zy,0));let co=d1(textureLoad(dY,d_.zw,0));let dw=mix(mix(a,b,e5.y),mix(t,co,e5.y),e5.x);let bE=dw*aC.bd*at[i];rgba[i]=rgba[i]*(d-bE.a)+bE;}}C+=2u;}case gU:{if bl<eE{for(var i=e;i<ai;i+=f){fU[bl][i]=pack4x8unorm(rgba[i]);rgba[i]=vec4(c);}}else{}bl+=f;C+=f;}case gT:{let aB=hN(C);bl-=f;for(var i=e;i<ai;i+=f){var fT:j;if bl<eE{fT=fU[bl][i];}else{}let bg=unpack4x8unorm(fT);var a4=rgba[i];var aL:L;if aB.c4{let e4=d/max(a4.a,1e-6);a4=vec4(a4.rgb*e4,a4.a);aL=aB.ck*a4.r+aB.cj*a4.g+aB.ci*a4.b+aB.b6*a4.a+aB.ch;aL=clamp(aL,vec4(c),vec4(d));aL=vec4(aL.rgb*aL.a,aL.a);}else{let new_rgb=aB.ck.rgb*a4.r+aB.cj.rgb*a4.g+aB.ci.rgb*a4.b+aB.b6.rgb*a4.a*a4.a+aB.ch.rgb*a4.a;aL=aB.b6.a*vec4(new_rgb,a4.a);aL=clamp(aL,vec4(c),vec4(min(d,aL.a)));}let e7=aL*at[i];rgba[i]=jh(bg,e7,aB.bn);}C+=23u;}case gS:{C=q[C+f];}default:{}}}let e3=vec2u(xy);for(var i=e;i<ai;i+=f){let cF=e3+vec2(i,e);if cF.x<n.hf&&cF.y<n.he{var aL=rgba[i];if n.iH!=e{let e4=d/max(aL.a,1e-6);aL=vec4(aL.rgb*e4,aL.a);}textureStore(aO,vec2i(cF),aL);}}}fn d1(rgba:L)->L{return vec4(rgba.rgb*rgba.a,rgba.a);}`
