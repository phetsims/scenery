/* eslint-disable */
import ptcl from './shared/ptcl.js';
import blend from './shared/blend.js';
import config from './shared/config.js';
import segment from './shared/segment.js';

export default `struct be{F:i32,W:u32}${segment}
${config}
@group(0)@binding(0)var<uniform>f:aF;@group(0)@binding(1)var<storage>N:array<be>;@group(0)@binding(2)var<storage>W:array<dx>;${blend}
${ptcl}
const fP=512;@group(0)@binding(3)var a7:texture_storage_2d<rgba8unorm,write>;@group(0)@binding(4)var<storage>j:array<u32>;@group(0)@binding(5)var eD:texture_2d<f32>;@group(0)@binding(6)var<storage>info:array<u32>;@group(0)@binding(7)var dJ:texture_2d<f32>;fn hz(p:u32)->fe{let t=j[p+1u];let F=i32(j[p+2u]);return fe(t,F);}fn hy(p:u32)->fd{let t=j[p+1u];let cS=bitcast<f32>(j[p+2u]);return fd(t,cS);}fn hx(p:u32)->d6{let cR=j[p+1u];return d6(cR);}fn hw(p:u32)->gI{let di=j[p+1u];let aK=di>>2u;let bG=di&3u;let H=j[p+2u];let d3=bitcast<f32>(info[H]);let fb=bitcast<f32>(info[H+1u]);let dy=bitcast<f32>(info[H+2u]);return gI(aK,bG,d3,fb,dy);}fn hv(p:u32)->gH{let di=j[p+1u];let aK=di>>2u;let bG=di&3u;let H=j[p+2u];let eK=bitcast<f32>(info[H]);let eJ=bitcast<f32>(info[H+1u]);let eI=bitcast<f32>(info[H+2u]);let eH=bitcast<f32>(info[H+3u]);let C=vec4(eK,eJ,eI,eH);let cy=vec2(bitcast<f32>(info[H+4u]),bitcast<f32>(info[H+5u]));let aV=bitcast<f32>(info[H+6u]);let aJ=bitcast<f32>(info[H+7u]);let fO=info[H+8u];let at=fO>>3u;let bx=fO&7u;return gH(aK,bG,C,cy,aV,aJ,bx,at);}fn hu(p:u32)->gG{let H=j[p+1u];let eK=bitcast<f32>(info[H]);let eJ=bitcast<f32>(info[H+1u]);let eI=bitcast<f32>(info[H+2u]);let eH=bitcast<f32>(info[H+3u]);let C=vec4(eK,eJ,eI,eH);let cy=vec2(bitcast<f32>(info[H+4u]),bitcast<f32>(info[H+5u]));let xy=info[H+6u];let fN=info[H+7u];let x=f32(xy>>16u);let y=f32(xy&0xffffu);let b7=f32(fN>>16u);let hr=f32(fN&0xffffu);return gG(C,cy,vec2(x,y),vec2(b7,hr));}fn ht(p:u32)->d5{let a2=j[p+1u];let bw=vec4(bitcast<f32>(j[p+2u]),bitcast<f32>(j[p+3u]),bitcast<f32>(j[p+4u]),bitcast<f32>(j[p+5u]));let bv=vec4(bitcast<f32>(j[p+6u]),bitcast<f32>(j[p+7u]),bitcast<f32>(j[p+8u]),bitcast<f32>(j[p+9u]));let bu=vec4(bitcast<f32>(j[p+10u]),bitcast<f32>(j[p+11u]),bitcast<f32>(j[p+12u]),bitcast<f32>(j[p+13u]));let aU=vec4(bitcast<f32>(j[p+14u]),bitcast<f32>(j[p+15u]),bitcast<f32>(j[p+16u]),bitcast<f32>(j[p+17u]));let bf=vec4(bitcast<f32>(j[p+18u]),bitcast<f32>(j[p+19u]),bitcast<f32>(j[p+20u]),bitcast<f32>(j[p+21u]));let cQ=j[p+22u]==1u;return d5(a2,bw,bv,bu,aU,bf,cQ);}fn bG(o:f32,bU:u32)->f32{let hq=0u;let hp=1u;let ho=2u;switch bU{case 0u:{return clamp(o,0.,1.);}case 1u:{return fract(o);}default:{return abs(o- 2.*round(.5*o));}}}const V=4u;fn fQ(t:be,xy:vec2f,cI:bool)->array<f32,V>{var ah:array<f32,V>;let hn=f32(t.F);for(var c=0u;c<V;c+=1u){ah[c]=hn;}var co=t.W;while co!=0u{let ac=W[co];let y=ac.cx.y-xy.y;let I=clamp(y,0.,1.);let M=clamp(y+ac.aq.y,0.,1.);let dm=I-M;if dm!=0.{let fM=1./ac.aq.y;let hm=(I-y)*fM;let hl=(M-y)*fM;let fL=ac.cx.x-xy.x;let B=fL+hm*ac.aq.x;let J=fL+hl*ac.aq.x;let hk=min(B,J);let hj=max(B,J);for(var c=0u;c<V;c+=1u){let fK=f32(c);let cq=min(hk-fK,1.)- 1.e-6;let fJ=hj-fK;let b=min(fJ,1.);let m=max(b,0.);let b9=max(cq,0.);let a=(b+.5*(b9*b9-m*m)-cq)/(fJ-cq);ah[c]+=a*dm;}}let aT=sign(ac.aq.x)*clamp(xy.y-ac.aT+1.,0.,1.);for(var c=0u;c<V;c+=1u){ah[c]+=aT;}co=ac.d2;}if cI{for(var c=0u;c<V;c+=1u){let a=ah[c];ah[c]=abs(a- 2.*round(.5*a));}}else{for(var c=0u;c<V;c+=1u){ah[c]=min(abs(ah[c]),1.);}}return ah;}fn hs(seg:u32,cS:f32,xy:vec2f)->array<f32,V>{var cE:array<f32,V>;for(var c=0u;c<V;c+=1u){cE[c]=1e9;}var co=seg;while co!=0u{let ac=W[co];let aq=ac.aq;let fI=xy+vec2(.5,.5)-ac.cx;let aY=1./dot(aq,aq);for(var c=0u;c<V;c+=1u){let fH=vec2(fI.x+f32(c),fI.y);let o=clamp(dot(fH,aq)*aY,0.,1.);cE[c]=min(cE[c],length(aq*o-fH));}co=ac.d2;}for(var c=0u;c<V;c+=1u){cE[c]=clamp(cS+.5-cE[c],0.,1.);}return cE;}@compute @workgroup_size(4,16)fn main(@builtin(global_invocation_id)E:vec3u,@builtin(local_invocation_id)d:vec3u,@builtin(workgroup_id)ae:vec3u,){let ay=ae.y*f.aA+ae.x;let xy=vec2(f32(E.x*V),f32(E.y));var rgba:array<vec4f,V>;for(var c=0u;c<V;c+=1u){rgba[c]=unpack4x8unorm(f.io).wzyx;}var fC:array<array<u32,V>,ee>;var a_=0u;var ah:array<f32,V>;var p=ay*d4;let f4=j[p];p+=1u;while true{let aQ=j[p];if aQ==gE{break;}switch aQ{case 1u:{let cv=hz(p);let W=cv.t>>1u;let cI=(cv.t&1u)!=0u;let t=be(cv.F,W);ah=fQ(t,xy,cI);p+=3u;}case 2u:{let aO=hy(p);ah=hs(aO.t,aO.cS,xy);p+=3u;}case 3u:{for(var c=0u;c<V;c+=1u){ah[c]=1.;}p+=1u;}case 5u:{let bZ=hx(p);let eG=unpack4x8unorm(bZ.cR).wzyx;for(var c=0u;c<V;c+=1u){let bp=eG*ah[c];rgba[c]=rgba[c]*(1.-bp.a)+bp;}p+=2u;}case 6u:{let cF=hw(p);let b9=cF.d3*xy.x+cF.fb*xy.y+cF.dy;for(var c=0u;c<V;c+=1u){let hi=b9+cF.d3*f32(c);let x=i32(round(bG(hi,cF.bG)*f32(fP- 1)));let dh=textureLoad(eD,vec2(x,i32(cF.aK)),0);let bp=dh*ah[c];rgba[c]=rgba[c]*(1.-bp.a)+bp;}p+=3u;}case 7u:{let bo=hv(p);let aV=bo.aV;let aJ=bo.aJ;let hh=bo.bx==gV;let hg=bo.bx==gW;let hf=bo.bx==gU;let fG=(bo.at&gT)!=0u;let fF=select(1./aJ,0.,hg);let he=select(1.,-1.,fG||(1.-aV)<0.);let hd=sign(1.-aV);for(var c=0u;c<V;c+=1u){let dg=vec2(xy.x+f32(c),xy.y);let fE=bo.C.xy*dg.x+bo.C.zw*dg.y+bo.cy;let x=fE.x;let y=fE.y;let xx=x*x;let yy=y*y;var o=0.;var dK=true;if hh{let a=aJ-yy;o=sqrt(a)+x;dK=a>=0.;}else if hf{o=(xx+yy)/x;dK=o>=0.&&x!=0.;}else if aJ>1.{o=sqrt(xx+yy)-x*fF;}else{let a=xx-yy;o=he*sqrt(a)-x*fF;dK=a>=0.&&o>=0.;}if dK{o=bG(aV+hd*o,bo.bG);o=select(o,1.-o,fG);let x=i32(round(o*f32(fP- 1)));let dh=textureLoad(eD,vec2(x,i32(bo.aK)),0);let bp=dh*ah[c];rgba[c]=rgba[c]*(1.-bp.a)+bp;}}p+=3u;}case 8u:{let bY=hu(p);let fD=bY.fa+bY.ib;for(var c=0u;c<V;c+=1u){let dg=vec2(xy.x+f32(c),xy.y);let dM=bY.C.xy*dg.x+bY.C.zw*dg.y+bY.cy+bY.fa;if all(dM<fD)&&ah[c]!=0.{let dL=vec4(max(floor(dM),bY.fa),min(ceil(dM),fD));let eF=fract(dM);let a=dN(textureLoad(dJ,vec2i(dL.xy),0));let b=dN(textureLoad(dJ,vec2i(dL.xw),0));let m=dN(textureLoad(dJ,vec2i(dL.zy),0));let b9=dN(textureLoad(dJ,vec2i(dL.zw),0));let dh=mix(mix(a,b,eF.y),mix(m,b9,eF.y),eF.x);let bp=dh*ah[c];rgba[c]=rgba[c]*(1.-bp.a)+bp;}}p+=2u;}case 9u:{if a_<ee{for(var c=0u;c<V;c+=1u){fC[a_][c]=pack4x8unorm(rgba[c]);rgba[c]=vec4(0.);}}else{}a_+=1u;p+=1u;}case 10u:{let L=ht(p);a_-=1u;for(var c=0u;c<V;c+=1u){var fB:u32;if a_<ee{fB=fC[a_][c];}else{}let bg=unpack4x8unorm(fB);var aX=rgba[c];var a6:vec4f;if L.cQ{let hc=1./max(aX.a,1e-6);aX=vec4(aX.rgb*hc,aX.a);a6=aX.r*L.bw+aX.g*L.bv+aX.b*L.bu+aX.a*L.aU+1.*L.bf;a6=clamp(a6,vec4(0.),vec4(1.));a6=vec4(a6.rgb*a6.a,a6.a);}else{a6=aX.r*L.bw+aX.g*L.bv+aX.b*L.bu+aX.a*L.aU+aX.a*L.bf;a6=clamp(a6,vec4(0.),vec4(min(1.,a6.a)));}let eG=a6*ah[c];rgba[c]=iY(bg,eG,L.a2);}p+=23u;}case 11u:{p=j[p+1u];}default:{}}}let eE=vec2u(xy);for(var c=0u;c<V;c+=1u){let cp=eE+vec2(c,0u);if cp.x<f.gS&&cp.y<f.gR{textureStore(a7,vec2i(cp),rgba[c]);}}}fn dN(rgba:vec4f)->vec4f{return vec4(rgba.rgb*rgba.a,rgba.a);}`
