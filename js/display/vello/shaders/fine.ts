/* eslint-disable */
import ptcl from './shared/ptcl.js';
import blend from './shared/blend.js';
import config from './shared/config.js';
import segment from './shared/segment.js';
import pre from './shared/pre.js';

export default `${pre}struct bv{O:m,aj:j}${segment}
${config}
@group(0)@binding(0)var<uniform>n:aT;@group(0)@binding(1)var<storage>X:array<bv>;@group(0)@binding(2)var<storage>aj:array<dL>;${blend}
${ptcl}
const f6=512;@group(0)@binding(3)var a2:texture_storage_2d<rgba8unorm,write>;@group(0)@binding(4)var<storage>q:aZ;@group(0)@binding(5)var e1:texture_2d<h>;@group(0)@binding(6)var<storage>info:aZ;@group(0)@binding(7)var dX:texture_2d<h>;fn hS(C:j)->fu{let F=q[C+f];let O=m(q[C+2u]);return fu(F,O);}fn hR(C:j)->ft{let F=q[C+f];let c5=bitcast<h>(q[C+2u]);return ft(F,c5);}fn hQ(C:j)->eu{let c4=q[C+f];return eu(c4);}fn hP(C:j)->g3{let dx=q[C+f];let aY=dx>>2u;let bd=dx&3u;let Q=q[C+2u];let er=bitcast<h>(info[Q]);let fr=bitcast<h>(info[Q+f]);let dM=bitcast<h>(info[Q+2u]);return g3(aY,bd,er,fr,dM);}fn hO(C:j)->g2{let dx=q[C+f];let aY=dx>>2u;let bd=dx&3u;let Q=q[C+2u];let P=bitcast<L>(vec4(info[Q],info[Q+f],info[Q+2u],info[Q+3u]));let cN=bitcast<B>(vec2(info[Q+4u],info[Q+5u]));let bc=bitcast<h>(info[Q+6u]);let aX=bitcast<h>(info[Q+7u]);let f5=info[Q+8u];let aE=f5>>3u;let bI=f5&7u;return g2(aY,bd,P,cN,bc,aX,bI,aE);}fn hN(C:j)->g1{let Q=q[C+f];let P=bitcast<L>(vec4(info[Q],info[Q+f],info[Q+2u],info[Q+3u]));let cN=bitcast<B>(vec2(info[Q+4u],info[Q+5u]));let xy=info[Q+6u];let f4=info[Q+7u];let bd=info[Q+8u];let x=m(xy>>16u);let y=m(xy&65535u);let aP=m(f4>>16u);let dw=m(f4&65535u);let cM=vec2(bd>>2u,bd&0x3);return g1(P,cN,vec2(x,y),vec2(aP,dw),cM);}fn hM(C:j)->et{let bl=q[C+f];let cj=bitcast<L>(vec4(q[C+2u],q[C+3u],q[C+4u],q[C+5u]));let ci=bitcast<L>(vec4(q[C+6u],q[C+7u],q[C+8u],q[C+9u]));let ch=bitcast<L>(vec4(q[C+10u],q[C+11u],q[C+12u],q[C+13u]));let b5=bitcast<L>(vec4(q[C+14u],q[C+15u],q[C+16u],q[C+17u]));let cg=bitcast<L>(vec4(q[C+18u],q[C+19u],q[C+20u],q[C+21u]));let c3=q[C+22u]==f;return et(bl,cj,ci,ch,b5,cg,c3);}const f3=e;const f2=f;const f1=2u;fn bd(A:h,by:j)->h{switch by{case f3:{return clamp(A,c,d);}case f2:{return fract(A);}default:{return abs(A- 2.*round(.5*A));}}}fn d1(i:m,size:m,by:j)->m{switch by{case f3:{return clamp(i,0i,size- 1i);}case f2:{if i>=0i{return i % size;}else{return size-((-i- 1i)% size)- 1i;}}case f1:{let hK=select(i,-i- 1i,i<0i);let e6=hK %(size*2i);if e6<size{return e6;}else{return 2i*size-e6- 1i;}}default:{return 0i;}}}const ai=4u;fn f7(F:bv,xy:B,cW:bool)->array<h,ai>{var at:array<h,ai>;let hJ=h(F.O);for(var i=e;i<ai;i+=f){at[i]=hJ;}var cD=F.aj;while cD!=e{let an=aj[cD];let y=an.cL.y-xy.y;let S=clamp(y,c,d);let V=clamp(y+an.aD.y,c,d);let dB=S-V;if dB!=c{let f0=d/an.aD.y;let hI=(S-y)*f0;let hH=(V-y)*f0;let f_=an.cL.x-xy.x;let J=f_+hI*an.aD.x;let T=f_+hH*an.aD.x;let hG=min(J,T);let hF=max(J,T);for(var i=e;i<ai;i+=f){let fZ=h(i);let cF=min(hG-fZ,d)- 1.e-6;let fY=hF-fZ;let b=min(fY,d);let t=max(b,c);let cn=max(cF,c);let a=(b+.5*(cn*cn-t*t)-cF)/(fY-cF);at[i]+=a*dB;}}let a9=sign(an.aD.x)*clamp(xy.y-an.a9+d,c,d);for(var i=e;i<ai;i+=f){at[i]+=a9;}cD=an.eq;}if cW{for(var i=e;i<ai;i+=f){let a=at[i];at[i]=abs(a- 2.*round(.5*a));}}else{for(var i=e;i<ai;i+=f){at[i]=min(abs(at[i]),d);}}return at;}fn hL(seg:j,c5:h,xy:B)->array<h,ai>{var cT:array<h,ai>;for(var i=e;i<ai;i+=f){cT[i]=1e9;}var cD=seg;while cD!=e{let an=aj[cD];let aD=an.aD;let fX=xy+vec2(.5,.5)-an.cL;let bh=d/dot(aD,aD);for(var i=e;i<ai;i+=f){let fW=vec2(fX.x+h(i),fX.y);let A=clamp(dot(fW,aD)*bh,c,d);cT[i]=min(cT[i],length(aD*A-fW));}cD=an.eq;}for(var i=e;i<ai;i+=f){cT[i]=clamp(c5+.5-cT[i],c,d);}return cT;}@compute @workgroup_size(4,16)fn main(@builtin(global_invocation_id)N:M,@builtin(local_invocation_id)k:M,@builtin(workgroup_id)ap:M){let aK=ap.y*n.aL+ap.x;let xy=vec2(h(N.x*ai),h(N.y));var rgba:array<L,ai>;for(var i=e;i<ai;i+=f){rgba[i]=unpack4x8unorm(n.iG).wzyx;}var fS:array<array<j,ai>,eD>;var bj=e;var at:array<h,ai>;var C=aK*es;let gs=q[C];C+=f;while true{let a7=q[C];if a7==g_{break;}switch a7{case gZ:{let cJ=hS(C);let aj=cJ.F>>f;let cW=(cJ.F&f)!=e;let F=bv(cJ.O,aj);at=f7(F,xy,cW);C+=3u;}case gY:{let a5=hR(C);at=hL(a5.F,a5.c5,xy);C+=3u;}case gX:{for(var i=e;i<ai;i+=f){at[i]=d;}C+=f;}case gW:{let b2=hQ(C);let e5=unpack4x8unorm(b2.c4).wzyx;for(var i=e;i<ai;i+=f){let bD=e5*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}C+=2u;}case gV:{let cU=hP(C);let cn=cU.er*xy.x+cU.fr*xy.y+cU.dM;for(var i=e;i<ai;i+=f){let hE=cn+cU.er*h(i);let x=m(round(bd(hE,cU.bd)*h(f6- 1)));let dv=textureLoad(e1,vec2(x,m(cU.aY)),0);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}C+=3u;}case gU:{let bC=hO(C);let bc=bC.bc;let aX=bC.aX;let hD=bC.bI==hg;let hC=bC.bI==hh;let hB=bC.bI==hf;let fV=(bC.aE&he)!=e;let fU=select(d/aX,c,hC);let hA=select(d,-d,fV||(d-bc)<c);let hz=sign(d-bc);for(var i=e;i<ai;i+=f){let du=vec2(xy.x+h(i),xy.y);let fT=bC.P.xy*du.x+bC.P.zw*du.y+bC.cN;let x=fT.x;let y=fT.y;let xx=x*x;let yy=y*y;var A=c;var dY=true;if hD{let a=aX-yy;A=sqrt(a)+x;dY=a>=c;}else if hB{A=(xx+yy)/x;dY=A>=c&&x!=c;}else if aX>d{A=sqrt(xx+yy)-x*fU;}else{let a=xx-yy;A=hA*sqrt(a)-x*fU;dY=a>=c&&A>=c;}if dY{A=bd(bc+hz*A,bC.bd);A=select(A,d-A,fV);let x=m(round(A*h(f6- 1)));let dv=textureLoad(e1,vec2(x,m(bC.aY)),0);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}}C+=3u;}case gT:{let aF=hN(C);let aP=aF.bR.x;let dw=aF.bR.y;for(var i=e;i<ai;i+=f){if at[i]!=c{let du=vec2(xy.x+h(i),xy.y);let e4=aF.P.xy*du.x+aF.P.zw*du.y+aF.cN;let d_=vec4i(vec4(floor(e4),ceil(e4)));let dZ=vec4(d1(d_.x,aP,aF.cM.x),d1(d_.y,dw,aF.cM.y),d1(d_.z,aP,aF.cM.x),d1(d_.w,dw,aF.cM.y))+vec4(aF.gP,aF.gP);let e3=fract(e4);let a=d0(textureLoad(dX,dZ.xy,0));let b=d0(textureLoad(dX,dZ.xw,0));let t=d0(textureLoad(dX,dZ.zy,0));let cn=d0(textureLoad(dX,dZ.zw,0));let dv=mix(mix(a,b,e3.y),mix(t,cn,e3.y),e3.x);let bD=dv*at[i];rgba[i]=rgba[i]*(d-bD.a)+bD;}}C+=2u;}case gS:{if bj<eD{for(var i=e;i<ai;i+=f){fS[bj][i]=pack4x8unorm(rgba[i]);rgba[i]=vec4(c);}}else{}bj+=f;C+=f;}case gR:{let aB=hM(C);bj-=f;for(var i=e;i<ai;i+=f){var fR:j;if bj<eD{fR=fS[bj][i];}else{}let bg=unpack4x8unorm(fR);var a3=rgba[i];var bp:L;if aB.c3{let hy=d/max(a3.a,1e-6);a3=vec4(a3.rgb*hy,a3.a);bp=aB.cj*a3.r+aB.ci*a3.g+aB.ch*a3.b+aB.b5*a3.a+aB.cg;bp=clamp(bp,vec4(c),vec4(d));bp=vec4(bp.rgb*bp.a,bp.a);}else{let new_rgb=aB.cj.rgb*a3.r+aB.ci.rgb*a3.g+aB.ch.rgb*a3.b+aB.b5.rgb*a3.a*a3.a+aB.cg.rgb*a3.a;bp=aB.b5.a*vec4(new_rgb,a3.a);bp=clamp(bp,vec4(c),vec4(min(d,bp.a)));}let e5=bp*at[i];rgba[i]=jf(bg,e5,aB.bl);}C+=23u;}case gQ:{C=q[C+f];}default:{}}}let e2=vec2u(xy);for(var i=e;i<ai;i+=f){let cE=e2+vec2(i,e);if cE.x<n.hd&&cE.y<n.hc{textureStore(a2,vec2i(cE),rgba[i]);}}}fn d0(rgba:L)->L{return vec4(rgba.rgb*rgba.a,rgba.a);}`
